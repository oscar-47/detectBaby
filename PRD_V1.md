# 微信小程序「B超生成新生儿照」PRD（V1）

版本：V1（基座版）  
计费：¥9.9/次（与“原图解锁”同价）  
范围：中国大陆微信小程序  
风格：写实（`style_id=realistic_v1`）  
留存：30 天（用户可一键删除）  

---

## 1. 背景与目标

用户上传婴儿 B 超图（必须通过校验），系统调用可插拔的 AI Image Provider 生成写实“新生儿出生照”。通过激励广告与付费（按张）变现。

### 1.1 目标（V1）
- 跑通核心闭环：上传→B超校验→（广告/付费）解锁生成→出图→保存相册→（广告/付费）解锁原图下载。
- 保证合规底座：强门禁（非 B 超/含敏感信息/低清晰度直接重传）、数据最小化、可删除、可追溯。
- 可扩展：Provider 可插拔；后续可加“父母照片增强”“多风格”“套餐/订阅”不破坏主链路。

### 1.2 非目标（V1 不做）
- 复杂多风格编辑、文本 prompt、社交社区、用户上传参考图库（首页参考图由运营后台自营维护）。

---

## 2. 核心业务规则（最终确认版）

### 2.1 校验门禁（强制）
- 上传后必须先做 B 超校验：`verdict=pass` 才允许进入“广告/付费解锁”。
- 校验失败：强制重传，不允许继续（避免用户看完广告/付费却无法生成）。

失败原因码（V1）：
- `NOT_ULTRASOUND`：疑似非 B 超
- `PII_DETECTED`：检测到姓名/医院/条码等敏感信息（需遮挡/重传）
- `LOW_CLARITY`：清晰度不足
- `FILE_INVALID`：文件损坏/格式不支持/超限

### 2.2 解锁与计费（每张二选一）
生成 1 张（写实）：
- **看激励视频** 或 **付费 ¥9.9** 二选一解锁生成。
- 生成后产出两类资产：
  - `view`：高清展示版（允许保存到相册；可带轻标识/可压缩，V1 允许配置）
  - `original`：原图（下载需要权限）

原图下载（仅当由广告解锁生成时默认锁定）：
- **看激励视频** 或 **付费 ¥9.9** 二选一解锁原图下载。
- 若用户选择“付费生成”，默认 **包含原图下载权限**（无需二次解锁）。

> 注：激励视频时长在微信侧不可强控。产品文案应使用“看 1 次激励视频”“看 1 次短激励”，不要写死 60s/15s。

### 2.3 时延体验目标
- 目标：用户从点击生成到看到结果，尽量 ≤20 秒。
- 实现：后端支持 `wait_ms≈18000` 的长轮询；超时则返回任务状态，前端继续轮询（指数退避）。

### 2.4 数据留存与删除
- 默认留存 30 天（生成资产+上传原图），到期自动清理（数据库标记 + 存储删除）。
- 提供用户“一键删除所有数据”入口：立即标记删除并触发异步清理。

---

## 3. 用户与场景

### 3.1 用户画像（V1）
- 准父母：好奇宝宝长相；希望操作简单、出图快、结果写实。

### 3.2 核心用户故事
- 我想上传 B 超图并快速生成 1 张写实宝宝图，保存到相册分享。
- 我愿意看一次广告体验生成，但如果效果满意愿意付费下载原图/再生成。

---

## 4. 信息架构与页面（小程序端）

### 4.1 页面列表
1) `首页 Home`
- 参考图瀑布流（由你自营维护）
- 入口：`立即生成`
- 合规入口：用户协议/隐私政策/免责声明（非医疗用途）

2) `上传 Upload`
- 选择图片：相册/拍照
- 编辑：裁剪/旋转（建议）
- 提示：B 超常含姓名/医院/条码，需遮挡；不通过需重传

3) `校验 Validate`
- 展示：校验进度
- 结果：
  - pass：进入解锁页
  - fail：展示原因码+可读文案，按钮“重新上传”

4) `解锁 Unlock`
- 按场景展示两种 action：
  - `生成解锁`：看广告 / 付费 ¥9.9
  - `原图解锁`：看广告 / 付费 ¥9.9（仅广告生成后需要）

5) `生成中 Job`
- 进度与提示：预计 20 秒内完成
- 超时策略：提示“生成中，可稍后在历史查看”，仍保持轮询

6) `结果 Result`
- 展示 `view` 图
- 操作：保存到相册、分享
- 原图：按钮“下载原图”（若锁定则先解锁）
- 再生成：返回解锁生成

7) `历史 History`
- 30 天内任务列表（缩略图+状态）
- 点击进入结果页

8) `设置/合规 Settings`
- 用户协议/隐私政策/免责声明
- 一键删除数据
- 客服/举报入口（建议）

### 4.2 关键交互与文案要点
- 校验失败：明确原因与操作建议（如“请遮挡姓名/医院信息后重新上传”）。
- 解锁页：清晰表达“广告/付费二选一”，避免“看完广告仍失败”的体验（由强门禁保证）。
- 保存相册：首次引导授权；拒绝后引导打开设置。

---

## 5. 埋点与指标（V1）

### 5.1 漏斗
- `home_view` → `start_generate_click`
- `upload_success`
- `validation_pass` / `validation_fail`（按 reason_code 分布）
- `unlock_prepare_gen` → `ad_completed_gen` / `pay_success_gen`
- `job_succeeded` / `job_failed`（按 provider / error_code）
- `save_to_album_success`
- `unlock_prepare_original` → `ad_completed_original` / `pay_success_original`
- `original_download_success`

### 5.2 核心指标
- 校验通过率、生成成功率、20 秒内出图比例
- 广告完成率、付费转化率（生成/原图）、ARPU、单次生成成本
- 30 天留存、复购次数分布

---

## 6. 风控与合规（大陆上架重点）

### 6.1 合规
- 明确声明：非医疗用途；用户对上传素材拥有使用权。
- 隐私政策/用户协议/免责声明：必须可访问且可追溯版本。
- 数据删除：一键删除+30 天自动清理。

### 6.2 安全与隐私
- 存储：上传与生成图存私有存储；通过临时链接访问（短有效期）。
- 最小化：不保存不必要的用户信息；主键使用 `openid`（云函数内取 `wxContext.OPENID`）。
- 审计：关键操作（解锁、支付、生成、下载）写入审计/流水，便于追踪风控。

### 6.3 防刷与成本控制
- 限频：按 `openid`/设备指纹（可选）/IP（可选）做频控。
- 同图去重：`sha256` 去重（可用于提示用户重复上传与节流）。
- 解锁会话一次性：`unlock_id` 单次消费 + TTL + 绑定上下文（upload/job/asset）。

---

## 7. 运营后台（最小可用）

### 7.1 参考图库
- 上传、上下架、排序、标签
- 独立于用户生成内容（目录/权限隔离）

### 7.2 任务与成本
- 查询：`job_id/openid/status/provider_id`
- 指标：耗时、错误码、成本（如 provider 返回）

### 7.3 风控配置
- 黑名单、限频阈值、同图去重策略

---

## 8. V2 扩展（预留，不影响 V1 主干）
- 父母照片增强：新增 `purpose=parent_face` 上传与人脸校验；在生成入参中追加 `parent_upload_ids`；作为更高权益/更高价位。
- 多 provider：灰度与 AB；按成本/成功率自动路由。
- 多风格：新增 `style_id` 配置与模板版本，不改接口主结构。

