# detectBaby 代码说明文档

> **⚠️ 重要说明：当前状态 vs 设计目标**
> 
> **当前运行版本（V1.0 推广期）**：
> - ✅ 每人**一次免费**生成体验
> - ✅ 无需观看广告，无需付费
> - ✅ 生成后直接下载，无权限限制
> 
> **计划正式版（代码已完整实现，待启用）**：
> - 📝 激励广告解锁（代码完整，前端已注释）
> - 📝 付费解锁 ¥9.9（完整支付流程已实现）
> - 📝 双层资产系统（展示图 + 原图权限控制）
> 
> 本文档同时介绍**当前实现**和**完整设计**，会明确标注哪些功能已启用、哪些待启用。

## 📋 项目概述

**detectBaby** 是一个基于微信小程序的 **B超图片生成新生儿照片** 的 AI 应用。它允许准父母上传婴儿的B超图片，通过 AI 技术生成写实的新生儿照片，让父母提前看到宝宝的样子。

### 核心价值
- **情感价值**：满足准父母对未来宝宝外貌的好奇心
- **技术创新**：利用 AI 图像生成技术将 B超图转换为写实婴儿照
- **当前阶段**：**推广期免费体验**（每人限一次免费生成）
- **计划商业模式**：激励广告 + 付费解锁（¥9.9/次）—— 代码已实现，待正式上线

---

## 🏗️ 技术架构

### 1. 平台与框架
- **前端**：微信小程序（WeChat Mini Program）
- **后端**：微信云开发（CloudBase）
  - 云函数（Cloud Functions）
  - 云数据库（Cloud Database）
  - 云存储（Cloud Storage）
- **AI 服务**：七牛图生图 API（可插拔的 Provider 设计）
- **支付**：微信支付（WeChat Pay）
- **广告**：微信激励视频广告

### 2. 项目结构

```
detectBaby/
├── miniprogram/              # 小程序前端代码
│   ├── app.js                # 应用入口
│   ├── app.json              # 全局配置
│   ├── app.wxss              # 全局样式
│   └── pages/                # 页面目录
│       ├── home/             # 首页（参考图展示）
│       ├── upload/           # 上传B超图页面
│       ├── validate/         # 校验结果页面
│       ├── unlock/           # 解锁页面（广告/付费）
│       ├── job/              # 生成进度页面
│       ├── result/           # 结果展示页面
│       ├── history/          # 历史记录页面
│       └── settings/         # 设置页面
│
├── cloudfunctions/           # 云函数（后端业务逻辑）
│   ├── login/                # 用户登录获取 openid
│   ├── validateUltrasound/   # B超图片校验
│   ├── unlockPrepare/        # 准备解锁会话
│   ├── unlockClaimAd/        # 广告解锁
│   ├── unlockClaimPay/       # 支付解锁
│   ├── orderCreate/          # 创建订单
│   ├── wxPrepay/             # 微信预支付
│   ├── wxPayNotify/          # 支付回调
│   ├── generationCreate/     # 创建 AI 生成任务
│   ├── generationGet/        # 查询生成状态
│   ├── assetGet/             # 获取资产链接
│   ├── originalDownload/     # 下载原图
│   ├── galleryHome/          # 首页参考图
│   ├── userHistory/          # 用户历史记录
│   └── userDataDelete/       # 删除用户数据
│
├── database/                 # 数据库集合定义
├── README.md                 # 项目说明
├── PRD_V1.md                 # 产品需求文档
└── API_V1.md                 # API 接口文档
```

---

## 🔄 核心业务流程

### 完整用户旅程

#### 当前推广期流程（V1.0 - 免费体验版）

```
1. 首页浏览
   ↓
2. 上传B超图 → 裁剪/编辑
   ↓
3. 自动校验
   ├─ 通过 → 直接开始生成
   └─ 失败 → 提示原因，要求重新上传
   ↓
4. AI 生成（约20秒）
   ├─ 首次使用 → 免费生成成功
   └─ 已使用过 → 提示"每人限免费体验一次"
   ↓
5. 查看结果
   ├─ 保存展示图到相册
   └─ 下载原图
   ↓
6. 历史记录（30天内可查看）
```

#### 计划正式版流程（代码已实现，待启用）

```
1. 首页浏览
   ↓
2. 上传B超图 → 裁剪/编辑
   ↓
3. 自动校验
   ├─ 通过 → 进入解锁页
   └─ 失败 → 提示原因，要求重新上传
   ↓
4. 选择解锁方式
   ├─ 看激励广告（免费）
   └─ 付费 ¥9.9
   ↓
5. AI 生成（约20秒）
   ↓
6. 查看结果
   ├─ 保存展示图到相册
   └─ 下载原图（广告生成需二次解锁，付费生成直接包含）
   ↓
7. 历史记录（30天内可查看）
```

### 关键业务规则

#### 0. **当前推广期限制**（重要！）
**当前实现**：
- 每个用户（openid）只能**免费生成一次**
- 不需要观看广告，不需要付费
- 生成时会检查该用户是否已有成功的生成记录
- 如果已生成过，返回 `LIMIT_EXCEEDED` 错误
- 代码位置：`cloudfunctions/generationCreate/index.js` (第132-146行)

**待正式上线的完整功能**：
- 解锁页面中的**广告选项已注释**（`miniprogram/pages/unlock/unlock.wxml` 第15-45行）
- **付费选项代码完整**，但在推广期不使用
- 所有解锁相关的云函数都已实现，待启用

#### 1. **强门禁校验**（validateUltrasound）
- **必须通过校验才能继续**
- 校验内容：
  - ✅ 是否为 B超图
  - ✅ 是否包含敏感信息（姓名、医院、条码等）
  - ✅ 清晰度是否足够
  - ✅ 文件是否有效
- 失败原因：
  - `NOT_ULTRASOUND`：不是B超图
  - `PII_DETECTED`：检测到个人信息
  - `LOW_CLARITY`：清晰度不足
  - `FILE_INVALID`：文件无效

#### 2. **解锁机制**（Unlock Session）—— 代码已实现，推广期暂未启用
**设计目标**：每次生成或下载原图都需要"解锁"，解锁方式二选一：
- **看激励视频广告**（免费）
- **付费 ¥9.9**

解锁会话特点：
- **一次性使用**：unlock_token 只能消费一次
- **有时效性**：设置 TTL（Time To Live）
- **强绑定上下文**：绑定特定的上传或任务

**当前状态**：
- 解锁相关的 4 个云函数已完整实现：
  - `unlockPrepare`：准备解锁会话
  - `unlockClaimAd`：广告解锁
  - `unlockClaimPay`：付费解锁  
  - `orderCreate`：创建订单
- 前端解锁页面中**广告选项已注释**，仅显示付费选项（但推广期不实际使用）
- 生成时**不验证 unlock_token**（推广期免费逻辑）

#### 3. **双层资产系统**（设计架构）
**设计目标**：每次生成产出两种资产：
- **view（展示图）**：
  - 高清版本
  - 可直接保存到相册
  - 可能带水印（可配置）
- **original（原图）**：
  - 最高质量原图
  - 需要权限才能下载
  - 付费生成自动包含，广告生成需二次解锁

**当前推广期实现**：
- 生成时直接产出图片
- 用户可直接下载，无需二次解锁
- 资产访问控制代码已实现（`originalDownload` 云函数），但推广期不启用

#### 4. **计费规则**
**推广期（当前）**：
- **完全免费**，每人限一次生成
- 无需观看广告，无需付费
- 所有功能（生成 + 原图下载）均免费

**计划正式版**（代码已实现）：
- **生成一次**：
  - 广告解锁：免费，但原图锁定
  - 付费解锁：¥9.9，包含原图权限
- **原图下载**（仅广告生成时需要）：
  - 广告解锁：免费
  - 付费解锁：¥9.9

---

## 💾 数据库设计

### 核心集合（Collections）

#### 1. **uploads**（上传记录）
```javascript
{
  uploadFileID: "cloud://xxx",
  openid: "user_openid",
  sha256: "file_hash",        // 用于去重
  purpose: "ultrasound",
  created_at: 1700000000
}
```

#### 2. **ultrasound_validations**（校验记录）
```javascript
{
  uploadFileID: "cloud://xxx",
  openid: "user_openid",
  verdict: "pass" / "fail",
  reason_codes: ["NOT_ULTRASOUND"],
  scores: { ultrasound: 0.95, clarity: 0.88 },
  pii: { 
    detected: true, 
    types: ["HOSPITAL", "NAME"] 
  },
  created_at: 1700000000
}
```

#### 3. **unlock_sessions**（解锁会话）
```javascript
{
  unlock_id: "session_id",
  openid: "user_openid",
  action: "GEN" / "UNLOCK_ORIGINAL",
  context: { uploadFileID: "xxx", job_id: "xxx" },
  method: "ad" / "pay",
  status: "prepared" / "authorized" / "consumed",
  unlock_token: "one_time_token",
  expires_at: 1700000000,
  created_at: 1700000000
}
```

#### 4. **generation_jobs**（生成任务）
```javascript
{
  job_id: "unique_job_id",
  openid: "user_openid",
  uploadFileID: "cloud://xxx",
  style_id: "realistic_v1",
  provider_id: "qiniu",
  status: "queued" / "generating" / "succeeded" / "failed",
  progress: 0-100,
  original_access: "locked" / "unlocked" / "included",
  error_code: "ERROR_CODE",
  cost: { amount_fen: 990, currency: "CNY" },
  created_at: 1700000000,
  finished_at: 1700000000
}
```

#### 5. **assets**（生成资产）
```javascript
{
  asset_id: "asset_id",
  job_id: "job_id",
  kind: "view" / "original",
  fileID: "cloud://xxx",
  mime: "image/jpeg",
  width: 1024,
  height: 1024,
  created_at: 1700000000
}
```

#### 6. **orders**（订单）
```javascript
{
  order_id: "order_id",
  openid: "user_openid",
  sku: "gen_with_original_1" / "unlock_original_1",
  qty: 1,
  amount_fen: 990,  // ¥9.9
  status: "created" / "paying" / "paid",
  unlock_id: "unlock_id",
  created_at: 1700000000
}
```

#### 7. **payments**（支付记录）
```javascript
{
  payment_id: "payment_id",
  order_id: "order_id",
  provider: "wechatpay",
  wx_txn_id: "wechat_transaction_id",  // 微信交易号（唯一）
  status: "success" / "failed",
  paid_at: 1700000000
}
```

---

## 🔐 安全与合规

### 1. **隐私保护**
- **最小化原则**：只收集必要信息（openid）
- **私有存储**：图片存储在云存储私有空间
- **临时链接**：通过短时效临时链接访问
- **可删除**：用户可一键删除所有数据
- **自动清理**：30 天后自动删除

### 2. **风控措施**
- **频率限制**：基于 openid/设备指纹/IP 限流
- **去重检测**：SHA256 哈希检测重复上传
- **会话管理**：unlock_token 一次性使用 + TTL
- **幂等性**：所有写入操作支持 idempotency_key

### 3. **合规要求**
- ✅ 用户协议
- ✅ 隐私政策
- ✅ 免责声明（非医疗用途）
- ✅ 数据删除权
- ✅ 审计日志

---

## 🎯 核心云函数详解

### 1. **validateUltrasound**（B超校验）
```javascript
// 输入
{ 
  uploadFileID: "cloud://xxx",
  sha256: "hash",
  idempotency_key: "key"
}

// 输出
{
  verdict: "pass" / "fail",
  reason_codes: ["PII_DETECTED"],
  scores: { ultrasound: 0.95, clarity: 0.88 },
  pii: { detected: true, types: ["HOSPITAL"] }
}
```

**作用**：强制校验上传的图片是否为合格的B超图，不合格则无法进入后续流程。

### 2. **unlockPrepare**（准备解锁）
```javascript
// 输入
{
  action: "GEN" / "UNLOCK_ORIGINAL",
  context: { uploadFileID: "xxx", job_id: "xxx" },
  idempotency_key: "key"
}

// 输出
{
  unlock_id: "session_id",
  methods: ["ad", "pay"],
  expires_at: 1700000000
}
```

**作用**：创建一个解锁会话，用户可以选择看广告或付费来解锁。

### 3. **unlockClaimAd**（广告解锁）
```javascript
// 输入
{
  unlock_id: "session_id",
  client_event_id: "event_id",
  device_fp: "fingerprint",
  idempotency_key: "key"
}

// 输出
{
  granted: true,
  unlock_token: "one_time_token",
  expires_at: 1700000000
}
```

**作用**：用户看完激励广告后，授予解锁权限，返回一次性 token。

### 4. **generationCreate**（创建生成任务）
```javascript
// 输入
{
  unlock_token: "token",
  uploadFileID: "cloud://xxx",
  style_id: "realistic_v1",
  idempotency_key: "key"
}

// 输出
{
  job_id: "job_id",
  status: "queued" / "generating",
  original_access: "locked" / "included"
}
```

**作用**：消费 unlock_token，创建 AI 生成任务，调用第三方 AI 服务生成婴儿照片。

### 5. **generationGet**（查询任务状态）
```javascript
// 输入
{
  job_id: "job_id",
  wait_ms: 18000  // 长轮询18秒
}

// 输出
{
  status: "succeeded" / "failed",
  progress: 100,
  assets: [{ asset_id: "xxx", kind: "view" }],
  original_access: "locked" / "included"
}
```

**作用**：查询 AI 生成任务的状态，支持长轮询以减少请求次数。

### 6. **originalDownload**（下载原图）
```javascript
// 输入
{
  job_id: "job_id",
  unlock_token: "token",  // 如果原图锁定则需要
  idempotency_key: "key"
}

// 输出
{
  temp_url: "https://xxx",
  expires_at: 1700000000
}
```

**作用**：获取原图下载链接。如果原图锁定，需要消费解锁 token。

---

## 💰 商业模式

### 当前阶段：推广期
**运营策略**：
- 每人一次**完全免费**体验
- 无广告，无付费
- 目标：积累用户、收集反馈、优化产品

### 计划正式版（代码已完整实现）

#### 收入来源
1. **激励视频广告**
   - 用户看广告免费生成
   - 按 CPM（千次展示）或 CPC（点击）计费
   - 微信广告平台分成
   - 代码状态：✅ 完整实现（`unlockClaimAd`），前端已注释待启用

2. **付费解锁**
   - 生成 + 原图：¥9.9
   - 仅原图解锁：¥9.9
   - 微信支付手续费约 0.6%
   - 代码状态：✅ 完整实现（支付流程、订单、回调全部完成）

#### 成本构成
- AI 生成成本（七牛 API 调用费用）
- 云存储成本
- 云函数调用成本
- 带宽成本

---

## 🚀 扩展性设计

### 可插拔 AI Provider
代码设计支持多个 AI 服务提供商：
```javascript
// Provider 接口
{
  createJob(input) -> { jobRef },
  poll(jobRef) -> { status, progress },
  fetchResult(jobRef) -> { image_url, metadata }
}
```

当前实现：七牛图生图 API  
未来可添加：OpenAI DALL-E、Midjourney、Stable Diffusion 等

### V2 扩展方向
1. **父母照片增强**：上传父母照片提高准确度
2. **多风格选择**：卡通风格、艺术风格等
3. **套餐/订阅**：包月无限生成
4. **社交功能**：分享到朋友圈、社区

---

## 🎨 用户体验设计

### 关键体验点
1. **快速生成**：目标 ≤20 秒出图
2. **明确引导**：校验失败时给出清晰的修改建议
3. **灵活选择**：广告和付费二选一，满足不同用户需求
4. **历史管理**：30 天内随时查看历史生成
5. **隐私保护**：一键删除所有数据

### 文案策略
- 校验失败："请遮挡姓名/医院信息后重新上传"
- 解锁提示："观看 1 次激励视频或付费 ¥9.9"
- 生成中："AI 正在为您生成，预计 20 秒"

---

## 📊 数据指标

### 关键漏斗
```
首页浏览 → 开始生成
  ↓
上传成功
  ↓
校验通过 / 校验失败
  ↓
准备解锁 → 广告完成 / 支付成功
  ↓
生成成功 / 生成失败
  ↓
保存相册
  ↓
原图解锁 → 广告完成 / 支付成功
  ↓
原图下载
```

### 核心指标
- **转化率**：校验通过率、生成成功率
- **体验指标**：20 秒内出图比例
- **收入指标**：广告完成率、付费转化率、ARPU
- **成本指标**：单次生成成本
- **留存**：30 天留存率、复购次数

---

## 🛠️ 技术亮点

### 1. **幂等性设计**
所有写入操作都支持 `idempotency_key`，避免重复提交：
```javascript
// 使用 openid + key + function_name 生成唯一标识
const idemKey = `${openid}_${idempotency_key}_${functionName}`;
```

### 2. **长轮询优化**
生成任务支持长轮询（wait_ms），减少轮询次数：
```javascript
// 等待最多 18 秒，有结果立即返回
generationGet({ job_id, wait_ms: 18000 });
```

### 3. **一次性令牌**
unlock_token 只能使用一次，防止重放攻击：
```javascript
{
  unlock_token: "token",
  status: "consumed",  // 消费后标记
  consumed_at: 1700000000
}
```

### 4. **去重机制**
使用 SHA256 检测重复上传，节省成本：
```javascript
{
  sha256: "file_hash",
  uploadFileID: "cloud://xxx"
}
```

---

## 📖 总结

**detectBaby** 是一个完整的商业化微信小程序项目，展示了：

✅ **完整的产品闭环**：从用户需求到商业变现（代码完整，分阶段上线）  
✅ **规范的技术架构**：云开发 + 云函数 + 云数据库  
✅ **安全的业务设计**：强校验、幂等性、一次性令牌  
✅ **合规的隐私保护**：最小化、可删除、审计日志  
✅ **灵活的扩展性**：可插拔 AI Provider、多风格支持  

### 当前状态（V1.0 推广期）
- ✅ **已上线运行**：每人一次免费体验
- ✅ **核心功能完整**：上传 → 校验 → AI生成 → 下载
- 📝 **变现功能待启用**：广告和付费代码已完整实现，待正式启用

### 代码完整度
这是一个 **生产级代码**，包含完整的：
- ✅ 前端 UI（8个页面全部实现）
- ✅ 后端业务逻辑（15个云函数全部实现）
- ✅ 数据库设计（7个集合及索引）
- ✅ 支付集成（微信支付完整流程）
- ✅ 广告集成（激励视频广告代码，前端已注释）
- ✅ AI 集成（七牛图生图 API）
- ✅ 安全与合规（校验、风控、隐私保护）

适合学习：
- 微信小程序开发
- 云开发架构
- AI 服务集成
- 支付与广告变现（已实现待启用）
- 数据安全与合规
- 分阶段产品上线策略

---

## 📚 相关文档

- [README.md](./README.md) - 项目说明与快速开始
- [PRD_V1.md](./PRD_V1.md) - 产品需求文档
- [API_V1.md](./API_V1.md) - API 接口文档
